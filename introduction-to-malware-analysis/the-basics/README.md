# The basics: Introduction to malware analysis
## What is malware?
In these notes we'll be exploring malware dissection and how it works internally, but what is malware exactly? Malware stands for malicious software and is any software that is used for malicious intents. Malware is an umbrella term that describes any malicious program or code that is harmful to systems.

While malware is always used for malicious purposes, the exact objective of a certain malware can be categorized depending of its intent and how it works. The most common targets can be divided as:
- **Disrupting** host system operations
- **Stealing** critical information, such as personal or financial data
- Obtaining **unauthorized access**
- **Espionage**
- Sending **spam**
- Utilizing the victim's system for nefarious purposes, like being part of a **botnet** for DDoS
- Locking the files behind passwords or encrypting them and asking for a **ransom** to give them back

### Types of malware
Depending on what these malwares attempt to do from the list above, and how they spread through a victim's environment, we refer to them by **different names**. Some spread through a host program being executed, or over email, others are self-contained and spread independently. Let's see some examples of these types:
- a **Virus** is a type of malware that infects the target with user intervention to copy itself and spread to other computers and systems
- **Worms** are similar to viruses, but they infect a victim's machine, but they differ in that they spread themselves without user intervention
- **Scareware** aims to use social engineering to trick the user into buying or downloading unwanted software or rogue security software that presents itself as antivirus software
- **Ransomware** locks the victim's system or encrypts the data on the machines then asks for money to unlock or decrypt that system
- **Botnets** are computer networks that are infected with some malware, and are controlled simultaneously by a command and control server These machines are often used for distributed denial of service attacks, sending spam emails or mining cryptocurrencies
- **Trojans** are pieces of software that act like regular programs but have malicious code running under them as well. The user is tricked into installing it in their system, and then the program performs malicious activity in the host machine
- **Spyware** is malware that attackers use to eavesdrop, gather information, or damage a victim's machine
- **Rootkits** conceal the existance of any malicious code in the system. Usually this code is paired with other malware to perform malicious activities while avoiding detection
- **keyloggers** track everything a user writes on the keyboard, and are used to steal passwords, credit catd numbers, instant messages, or emails
- **Logic bombs** are portions of code that remain dormant for a period of time and are then triggered when certain conditions are met
- **Backdoors** or RATs are malwares that the attacker installs on the victim's machine without their knowledge and allows the attacker to connect to the victim's machine whenever they want. Many RATs also support modules to add functionality
- an information **stealer** is a type of malware with the main purpose of stealing information from the victim and sending it to the attacker, such as documents in the machine
- **Downloaders** are paired with other malware to fetch and install the rest of the payload or other malware components
- **Droppers** are malwares that have another malware executable inside it, used to drop that malware payload into a victim
- **Adware** programs open unwanted advertisements to users

## Why do we need malware analysis?
Malware analysis is the practice of dissecting malicious software so we can answer three main questions:
- How does it **work**?
- How can we **detect** it?
- How can we **eliminate** the threat it creates?

We have to keep in mind each analyst dissects malware in their own different way. There are standard approaches and methods used, but the techniques and tools may differ from one person to another, which makes the field very open to different methods and approaches.

There are many reasons malware analysis is important, especially to determine:
- The **nature** of the malware and its goals
- What **behavior** does it have and what damage it causes
- What **indicators** can help us detect the malware in future executions, either in system or through the network
- What **vulnerabilities** were exploited on the compromised machine and how the attacker moved between resources, if relevant
- **Who the threat is attributed to**, and if the threat actors are still present inside of your system or network
- How we can use this information to **respond** to or eliminate the threat

In these notes, we'll focus on how to analyze malware and understand the offensive techniques the malware developers use. We will look into unmanaged code, specifically windows executables written in C/C++. Scripts like Powershell or Python threats are not covered here. This analysis process can either involve or not involve reverse engineering, as RE is just one of the techniques we can use to analyze a malware sample. **Having RE skills is not necessary for malware analysis**, and vice versa, but having both skills under your belt will help you overcome more complicated challenges.

In the terms of business needs, hundreds or thousands of data breaches and attacks are documented daily, and most of them involve an attacker planting malware in the target environment as part of the attack framework to gain foothold in the victim's network. As threat detection vendors like CrowdStrike or Sophos point out in their reports, this is a cat and mouse **ongoing process that never stops**, so having these techniques on our hands will help us keep an edge over the potential attackers.

### Basic tools used in malware analysis
Tools appear, change and evolve, but the concepts behind them mostly remain the same over time. As long as we understand the needs behind a certain field, we can pick the correct tool for it. Common tool categories we'll need include:
- **File format** analyzers
- System and **network monitoring** tools
- **Debuggers** and **disassemblers**
- Small utilities like data **converters**, **decryptors**, **editors** and **registry tools**
- **Virtualization** tools to create contained environments
- An **IDE** you're comfortable with in case you need to write code

### What about writing signatures?
Once we finish analyzing and dissecting a malware sample and we know how it works, we can write a set of **signatures** that we can use to detect this malware or similarly-behaving threats in real environments. We refer to these signatures as **Indicators of Compromise**. We will explore indicators of compromise in depth in a future module in these notes.

## Analysis techniques
Performing malware analysis is done by following two main methods, either using **static** analysis, or **dynamic** analysis. Both techniques are used together to get a report. Let's go into each of these techniques in a bit more detail.

### Static analysis
Static analysis is done by dissecting the malware without executing it. This can be further divided into two distinct approaches:
- **Basic** static analysis is where we try to analyse the malware by analysing the file, its structure, and the functions being used
- **Advanced** static analysis digs deeper than the basic variant, attempting to understand the malware based on its low-level instructions. This is where the malware sample is usually disassembled.

### Dynamic analysis
Dynamic analysis is done by actually executing the malware sample and monitoring its behavior. This can also be further divided into the two categories we just saw:
- **Basic** dynamic analysis is running the malware sample in a contained environment with different monitoring tools preinstalled and trying to understand what the malware is doing based on the output of those tools
- **Advanced** dynamic analysis is used when we cannot analyse the malware using the basic method, for example if it has anti-analysis controls baked in. Here, we must run the sample using a debugger so we have further control over its execution to modify it if needed to remove the anti-analysis controls

### Is this a step-by-step process?
An important detail to keep in mind is that the final goal is to **provide answers to the three core questions** we metioned earlier. We are not required to understand every single instruction in the malware sample and waste time, effort and money on details that provide no benefit to our three core questions. We might not need all methods to answer our questions about a malware sample.

## Malware samples
There are many resources online that can be used to find malware samples to play with and enhance malware analysis skills. Some of these resources are completely free and do not require registration. Others may be commercial resources, but the free ones should suffice for learning experiences, since we will find a wide variety of samples we can use, like:
- [TheZoo](https://github.com/ytisf/theZoo)
- [Malware-Traffic-Analysis](https://www.malware-traffic-analysis.net/)
- [Malware-Samples](https://github.com/fabrimagic72/malware-samples)
- [tekDefense malware samples](http://www.tekdefense.com/downloads/malware-samples/)
- [inQuest malware samples](https://awesomeopensource.com/project/InQuest/malware-samples)
- [Contagio malware dump](https://contagiodump.blogspot.com/)

You should also have some useful tools on your radar:
- [Cuckoo sandbox](https://cuckoosandbox.org/)
- [any.run malware analysis sandbox](https://app.any.run/)
- [Automated malware analysis engine](https://www.hybrid-analysis.com/)
- [VirusTotal](https://www.virustotal.com/gui/home/upload)

## Acquisition tools
While we focus these notes on malware analysis, it might also be good to know rhe different tools that can help you with the extraction of samples and related evidence in an investigation. Let's go over a couple tools that could be useful for evidence acquisition:

### Disk imaging tools
- **Belkasoft acquisiton tool** for drive imaging, removable devices, mobile devices and cloud data
- **Magnet ACQUIRE** for hard drives and removable media, and iOS/Android devices
- **FTK Imager** for hard drive or removable devices

### Memory acquisition tools
- **Belkasoft acquisition tool**, also compatible with memory dumping
- **Magnet ACQUIRE**, also compatible with memory dumping
- **DumpIt**, a memory acquisition tool for memory forensics that enables practiciones to perform physical memory acquisition for Windows, also providing additional debugging data structures needed for memory analysis frameworks like Rekall and Volatility
- **Memdump**, part of Nirsoft's Cmd tools, which reads memory based on parameters and saves it to a text file
- **Belkasoft RAM capturer**, providing a reliable extraction of memory contents with low footprint, even if it is protected by an anti-dumping system or active anti-debugging mesures.
- **Magnet RAM capturer**, used for rapid collection of physical memory, later used to investigate artifacts. Captured data can be exported in several different raw formats.

### Other tools
- **Kroll Artifact Parser and Extractor (KAPE)** is an efficient, highly configurable triage tiik that targets any device or storage location, and finds and exports useful forensics artifacts, and parse them for further analysis
- **Rawcopy** is a command line application that copies files from NTFS volumes by using low level disk reading methods
- Some free EDRs, like **GRR**, **OSQuery** or **Velociraptor** have the capability of extracting evidences for forensics analysis
